\documentclass{ETHExercise}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{float}
\usepackage{subfig}
\usepackage{adjustbox}
\usepackage[margin=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{capt-of}
\usepackage{tabularx}
\usepackage{bm}
\usepackage{amsmath}
\usepackage{datetime}
\usepackage{listings}
\usepackage{subcaption}



\pagestyle{fancy}
\fancyhf{}
\fancyfoot[L]{263-5902-00L W23 / Lab report}
\fancyfoot[C]{\thepage}
\fancyfoot[R]{Computer Science\\ETH ZÃ¼rich}
\renewcommand{\footrulewidth}{0.05pt}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrule}{\hrule width\textwidth height\footrulewidth \vskip 2pt}
\newcommand{\timestamp}{\ddmmyyyydate\today \,\,- \currenttime h}

\usepackage{mdframed}
\usepackage{etoolbox}

\newtoggle{showA}
\toggletrue{showA}





\hypersetup{colorlinks,urlcolor=blue}
\lstset{
  backgroundcolor=\color{lightgray!20},
  basicstyle=\small\ttfamily,
  keywordstyle=\color{blue}\ttfamily,
  language=C,
  numbers=left,
  stepnumber=1,
  tabsize=4,
  showspaces=false,
  showstringspaces=false,
}
\title{Lab 2}
\author{Filippo Ficarra}
\begin{document}


\lectureheader{Prof. M. Pollefeyes}
{}
{\Large Computer Vision}{Fall 2023}
\begin{center}
    {\Huge Filippo Ficarra: Lab 2 - Feature extraction and Optical flow }\\
      \quad\newline
      fficarra@student.ethz.ch, 22--938--062.\\
      \quad\newline
      \timestamp
      \end{center}

\section{Introduction}
In this lab we aim to extract features from images, 
such as corners, using Harris detection and match descriptors 
between two different photos of the same thing.

\section{Harris corner detection}
The idea of Harris corner detection is to analyze the change
of intensity of pixels in a window. Using this idea we can 
basically identify three different regions:
\begin{itemize}
  \item flat: there is no change of intensity in all the directions
  \item edge: there is no change of intensity in the direction of the edge
  \item corner: large change of intensity in all the directions
\end{itemize}

To perform this analysis we define a window $\bm{W}$ and we define
the SSD error as:
\begin{center}
  $E(u, v) = \sum\limits_{(x, y) \in \bm{W}} \left[I(x+u, y+v) - I(x, y)\right]^2$
\end{center}
using Taylor approximation we can approximate the error with:
\begin{center}
  $E(\Delta x, \Delta v) \approx \left[\Delta x, \Delta y\right] M \begin{bmatrix}
    \Delta x\\
    \Delta y
  \end{bmatrix}$, $M = \sum \begin{bmatrix}
    I_x^2 & I_xI_y\\
    I_xI_y & I_y^2
  \end{bmatrix}$
\end{center}
Note that $I_y$ and $I_y$ are respectively the partial derivative of the image
with respect to x and y.

\subsection{Image derivatives}

Since images are discrete we need to compute some approximation of the derivative.
The approximation used in this case is the following:
\begin{center}
  $I_x = \frac{I(x+1, y)- I(x-1, y)}{2}$, $I_y = \frac{I(x, y+1)- I(x, y-1)}{2}$
\end{center}
We can exploit the convolution operations to compute these derivatives, 
using the following filters:
\begin{center}
  filter\textsubscript{x} = $\begin{bmatrix}
    \begin{bmatrix}
      -0.5 & 0 & 0.5
    \end{bmatrix}
  \end{bmatrix}
  $, filter\textsubscript{y} = $\begin{bmatrix}
    \begin{bmatrix}
      -0.5 
    \end{bmatrix},
    \begin{bmatrix}
     0 
    \end{bmatrix},
    \begin{bmatrix}
    0.5
    \end{bmatrix}
  \end{bmatrix}
  $
\end{center}
This convolutions have been done in python in the following way:
\begin{lstlisting}[language=Python, caption=Image gradients]
  filter_x = np.array([[1/2, 0, -1/2]])
  filter_y = np.array([[1/2],[0],[-1/2]])

  I_x = signal.convolve2d(img, filter_x, mode='same')
  I_y = signal.convolve2d(img, filter_y, mode='same')
\end{lstlisting}

\subsection{Gaussian blur and local-auto correlation matrix}

The next step is to introduce blur in the image to make the detection 
more robust. Applying a Gaussian Blur filter prior to performing corner 
detection serves the purpose of decreasing image noise, thereby enhancing 
the outcome of corner-detection. 

To do so we use a gaussian kernel $g$, thus the matrix M is 
the following:
\begin{center}
  $M = g * \begin{bmatrix}
    I_x^2 & I_xI_y\\
    I_xI_y & I_y^2
  \end{bmatrix}$
\end{center}

Furthermore to compute the response function C we will need just this 3 elements:
\begin{lstlisting}[language=Python, caption=Local auto-correlation matrix elements]
  I_xx_blur = cv2.GaussianBlur(I_x**2,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  I_yy_blur = cv2.GaussianBlur(I_y**2,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  I_xy_blur = cv2.GaussianBlur(I_x*I_y,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  # 3. Compute elements of the local auto-correlation matrix "M"

  g_xx = I_xx_blur
  g_yy = I_yy_blur
  g_xy = I_xy_blur
\end{lstlisting}

\subsection{Harris response and corner detection}
The Harris detector uses the following function to score
the presence of corners:
\begin{center}
  $C = \lambda_1 \lambda_2 - k (\lambda_1 + \lambda_2)^2 = \det(M) - k (trace(M))^2$
\end{center}
therefore if
\begin{itemize}
  \item $\lambda_1 \sim 0$ and $\lambda_2 \sim 0 \implies C \ll 0$ and the region is flat,
   since the intensity of the pixels doesn't really change in that region
  \item $\lambda_2 \gg \lambda_1 \implies C < 0$ and we detect an horizontal edge
  \item $\lambda_1 \gg \lambda_2 \implies C < 0$ and we detect a vertica edge
  \item $\lambda_1 \sim \lambda_2$ and both large, $\implies C > 0$ and we detect a corner
\end{itemize}
Alternatively to use $\det(M)$ and $trace(M)$, we can rewrite the response function like this:
\begin{center}
  $C = g(I_x^2)g(I_y^2)- [g(I_x I_y)]^2 - k[ g(I_x^2)+g(I_y^2)]^2$
\end{center}
and then we can reuse the components derived above:
\begin{lstlisting}[language=Python, caption=Harris response function]
  C = (g_xx * g_yy - (g_xy**2) - k * (g_xx + g_yy)**2)
\end{lstlisting}

In order to detect corners we need just to compare every entry of
the response with a threshold and perform non-maximum suppression.
A non-maximum suppression process allows selecting a unique feature in each neighborhood.

This has been performed in python like this:

\begin{lstlisting}[language=Python, caption=Local auto-correlation matrix elements]
  corners = np.argwhere((C > thresh) & (C == ndimage.maximum_filter(C, (3,3))))
  corners = corners[:, [1, 0]] # convention row = y, column = x
\end{lstlisting}


\subsection{Results}
In this section I'll show the result of the detection for the different parameters Sigma (Gaussian Blur),
k (Response function) and the threshold.

As expected, when one decreases the threshold, the number of corners detected is greater but not so accurate.

\begin{figure}[!htb]
\minipage{0.32\textwidth}
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_0.0001_keypoints_5.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-4 and keypoints = 5}
\endminipage\hfill
\minipage{0.32\textwidth}
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_5e-05_keypoints_13.png}
  \caption{k = 0.04, sigma = 0.5, t = 5e-5 and keypoints = 13}
\endminipage\hfill
\minipage{0.32\textwidth}%
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_1e-05_keypoints_34.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-5 and keypoints = 34}
\endminipage\hfill
\minipage{0.32\textwidth}%
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_5e-06_keypoints_46.png}
  \caption{k = 0.04, sigma = 0.5, t = 5e-6 and keypoints = 46}
\endminipage\space\space\space 
\minipage{0.32\textwidth}%
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_1e-06_keypoints_127.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-6 and keypoints = 127}
\endminipage
\end{figure}
\begin{figure}
  \minipage{0.32\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_0.0001_keypoints_23.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-4 and keypoints = 23}
  \endminipage\hfill
  \minipage{0.32\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_5e-05_keypoints_51.png}
    \caption{k = 0.04, sigma = 0.5, t = 5e-5 and keypoints = 51}
  \endminipage\hfill
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_1e-05_keypoints_134.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-5 and keypoints = 134}
  \endminipage\hfill
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_5e-06_keypoints_173.png}
    \caption{k = 0.04, sigma = 0.5, t = 5e-6 and keypoints = 173}
  \endminipage\space\space\space 
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_1.0_t_1e-06_keypoints_222.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-6 and keypoints = 222}
  \endminipage
\end{figure}

A greater effect was given increasing k to 0.06 with sigma 1.0 or 2.0. Increasing k reduces the
response function so the number of points should be lower, while increasing the value of sigma

\begin{figure}
  \minipage{0.32\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_0.0001_keypoints_8.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-4 and keypoints = 8}
  \endminipage\hfill
  \minipage{0.32\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_5e-05_keypoints_18.png}
    \caption{k = 0.06, sigma = 2.0, t = 5e-5 and keypoints = 18}
  \endminipage\hfill
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_1e-05_keypoints_41.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-5 and keypoints = 41}
  \endminipage\hfill
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_5e-06_keypoints_50.png}
    \caption{k = 0.06, sigma = 2.0, t = 5e-6 and keypoints = 50}
  \endminipage\space\space\space 
  \minipage{0.32\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_1e-06_keypoints_79.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-6 and keypoints = 79}
  \endminipage
\end{figure}
\begin{figure}
    \minipage{0.32\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_0.0001_keypoints_19.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-4 and keypoints = 19}
    \endminipage\hfill
    \minipage{0.32\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-05_keypoints_42.png}
      \caption{k = 0.06, sigma = 2.0, t = 5e-5 and keypoints = 42}
    \endminipage\hfill
    \minipage{0.32\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_1e-05_keypoints_115.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-5 and keypoints = 115}
    \endminipage\hfill
    \minipage{0.32\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-06_keypoints_154.png}
      \caption{k = 0.06, sigma = 2.0, t = 5e-6 and keypoints = 154}
    \endminipage\space\space\space 
    \minipage{0.32\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_1.0_t_1e-06_keypoints_191.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-6 and keypoints = 191}
    \endminipage
  \end{figure}


\newpage
\section{Matching}

The evaluation was done with these parameters $HARRIS_SIGMA = 1.0, HARRIS_K = 0.05 \text{and} HARRIS_THRESH = 1e-5$

\end{document}
