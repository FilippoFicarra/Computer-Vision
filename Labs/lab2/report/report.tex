\documentclass{ETHExercise}
\usepackage{hyperref}
\usepackage{enumitem}
\usepackage{graphicx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{float}
\usepackage{subfig}
\usepackage{adjustbox}
\usepackage[margin=2cm]{geometry}
\usepackage{fancyhdr}
\usepackage{capt-of}
\usepackage{tabularx}
\usepackage{bm}
\usepackage{amsmath}
\usepackage{datetime}
\usepackage{listings}
\usepackage{subcaption}



\pagestyle{fancy}
\fancyhf{}
\fancyfoot[L]{263-5902-00L W23 / Lab report}
\fancyfoot[C]{\thepage}
\fancyfoot[R]{Computer Science\\ETH ZÃ¼rich}
\renewcommand{\footrulewidth}{0.05pt}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrule}{\hrule width\textwidth height\footrulewidth \vskip 2pt}
\newcommand{\timestamp}{\ddmmyyyydate\today \,\,- \currenttime h}

\usepackage{mdframed}
\usepackage{etoolbox}

\newtoggle{showA}
\toggletrue{showA}





\hypersetup{colorlinks,urlcolor=blue}
\lstset{
  backgroundcolor=\color{lightgray!20},
  basicstyle=\small\ttfamily,
  keywordstyle=\color{blue}\ttfamily,
  language=C,
  numbers=left,
  stepnumber=1,
  tabsize=4,
  showspaces=false,
  showstringspaces=false,
}
\title{Lab 2}
\author{Filippo Ficarra}
\begin{document}


\lectureheader{Prof. M. Pollefeyes}
{}
{\Large Computer Vision}{Fall 2023}
\begin{center}
    {\Huge Filippo Ficarra: Lab 2 - Feature extraction and Optical flow }\\
      \quad\newline
      fficarra@student.ethz.ch, 22--938--062.\\
      \quad\newline
      \timestamp
      \end{center}

\section{Introduction}
In this lab we aim to extract features from images, 
such as corners, using Harris detection and match descriptors 
between two different photos of the same thing.

\section{Harris corner detection}
The idea of Harris corner detection is to analyze the change
of intensity of pixels in a window. Using this idea we can 
basically identify three different regions:
\begin{itemize}
  \item flat: there is no change of intensity in all the directions
  \item edge: there is no change of intensity in the direction of the edge
  \item corner: large change of intensity in all the directions
\end{itemize}

To perform this analysis we define a window $\bm{W}$ and we define
the SSD error as:
\begin{center}
  $E(u, v) = \sum\limits_{(x, y) \in \bm{W}} \left[I(x+u, y+v) - I(x, y)\right]^2$
\end{center}
using Taylor approximation we can approximate the error with:
\begin{center}
  $E(\Delta x, \Delta v) \approx \left[\Delta x, \Delta y\right] M \begin{bmatrix}
    \Delta x\\
    \Delta y
  \end{bmatrix}$, $M = \sum \begin{bmatrix}
    I_x^2 & I_xI_y\\
    I_xI_y & I_y^2
  \end{bmatrix}$
\end{center}
Note that $I_y$ and $I_y$ are respectively the partial derivative of the image
with respect to x and y.

\subsection{Image derivatives}

Since images are discrete we need to compute some approximation of the derivative.
The approximation used in this case is the following:
\begin{center}
  $I_x = \frac{I(x+1, y)- I(x-1, y)}{2}$, $I_y = \frac{I(x, y+1)- I(x, y-1)}{2}$
\end{center}
We can exploit the convolution operations to compute these derivatives, 
using the following filters:
\begin{center}
  filter\textsubscript{x} = $\begin{bmatrix}
    \begin{bmatrix}
      -0.5 & 0 & 0.5
    \end{bmatrix}
  \end{bmatrix}
  $, filter\textsubscript{y} = $\begin{bmatrix}
    \begin{bmatrix}
      -0.5 
    \end{bmatrix},
    \begin{bmatrix}
     0 
    \end{bmatrix},
    \begin{bmatrix}
    0.5
    \end{bmatrix}
  \end{bmatrix}
  $
\end{center}
This convolutions have been done in python in the following way:
\begin{lstlisting}[language=Python, caption=Image gradients]
  filter_x = np.array([[1/2, 0, -1/2]])
  filter_y = np.array([[1/2],[0],[-1/2]])

  I_x = signal.convolve2d(img, filter_x, mode='same')
  I_y = signal.convolve2d(img, filter_y, mode='same')
\end{lstlisting}

\subsection{Gaussian blur and local-auto correlation matrix}

The next step is to introduce blur in the image to make the detection 
more robust. Applying a Gaussian Blur filter prior to performing corner 
detection serves the purpose of decreasing image noise, thereby enhancing 
the outcome of corner-detection. 

To do so we use a gaussian kernel $g$, thus the matrix M is 
the following:
\begin{center}
  $M = g * \begin{bmatrix}
    I_x^2 & I_xI_y\\
    I_xI_y & I_y^2
  \end{bmatrix}$
\end{center}

Furthermore to compute the response function C we will need just this 3 elements:
\begin{lstlisting}[language=Python, caption=Local auto-correlation matrix elements]
  I_xx_blur = cv2.GaussianBlur(I_x**2,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  I_yy_blur = cv2.GaussianBlur(I_y**2,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  I_xy_blur = cv2.GaussianBlur(I_x*I_y,(5,5),sigma,borderType=cv2.BORDER_REPLICATE)

  # 3. Compute elements of the local auto-correlation matrix "M"

  g_xx = I_xx_blur
  g_yy = I_yy_blur
  g_xy = I_xy_blur
\end{lstlisting}

\subsection{Harris response and corner detection}
The Harris detector uses the following function to score
the presence of corners:
\begin{center}
  $C = \lambda_1 \lambda_2 - k (\lambda_1 + \lambda_2)^2 = \det(M) - k (trace(M))^2$
\end{center}
therefore if
\begin{itemize}
  \item $\lambda_1 \sim 0$ and $\lambda_2 \sim 0 \implies C \ll 0$ and the region is flat,
   since the intensity of the pixels doesn't really change in that region
  \item $\lambda_2 \gg \lambda_1 \implies C < 0$ and we detect an horizontal edge
  \item $\lambda_1 \gg \lambda_2 \implies C < 0$ and we detect a vertica edge
  \item $\lambda_1 \sim \lambda_2$ and both large, $\implies C > 0$ and we detect a corner
\end{itemize}
Alternatively to use $\det(M)$ and $trace(M)$, we can rewrite the response function like this:
\begin{center}
  $C = g(I_x^2)g(I_y^2)- [g(I_x I_y)]^2 - k[ g(I_x^2)+g(I_y^2)]^2$
\end{center}
and then we can reuse the components derived above:
\begin{lstlisting}[language=Python, caption=Harris response function]
  C = (g_xx * g_yy - (g_xy**2) - k * (g_xx + g_yy)**2)
\end{lstlisting}

In order to detect corners we need just to compare every entry of
the response with a threshold and perform non-maximum suppression.
A non-maximum suppression process allows selecting a unique feature in each neighborhood.

This has been performed in python like this:

\begin{lstlisting}[language=Python, caption=corners]
  corners = np.argwhere((C > thresh) & (C == ndimage.maximum_filter(C, (3,3))))
  corners = corners[:, [1, 0]] # convention row = y, column = x
\end{lstlisting}


\subsection{Results}
In this section I'll show the result of the detection for the different parameters Sigma (Gaussian Blur),
k (Response function) and the threshold.

As expected, when one decreases the threshold, the number of corners detected is greater but not so accurate.
Increasing the value of k reduces the number of points since the response function gets smaller as shown in the first two pairs of 
images (here every parameter is fixed and k = = 0.04 and k = 0.06). Increasing k we will
detect less edges, but also real corners. 

\begin{figure}[!h]
\minipage{0.2\textwidth}
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_0.0001_keypoints_5.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-4 and keypoints = 5}
\endminipage\hfill
\minipage{0.2\textwidth}
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_5e-05_keypoints_13.png}
  \caption{k = 0.04, sigma = 0.5, t = 5e-5 and keypoints = 13}
\endminipage\hfill
\minipage{0.2\textwidth}%
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_1e-05_keypoints_34.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-5 and keypoints = 34}
\endminipage\hfill
% \minipage{0.2\textwidth}%
%   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_5e-06_keypoints_46.png}
%   \caption{k = 0.04, sigma = 0.5, t = 5e-6 and keypoints = 46}
% \endminipage\space\space\space 
\minipage{0.2\textwidth}%
  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.04_sigma_0.5_t_1e-06_keypoints_127.png}
  \caption{k = 0.04, sigma = 0.5, t = 1e-6 and keypoints = 127}
\endminipage
\end{figure}
\begin{figure}[!h]
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_0.0001_keypoints_4.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-4 and keypoints = 4}
  \endminipage\hfill
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_5e-05_keypoints_10.png}
    \caption{k = 0.06, sigma = 0.5, t = 5e-5 and keypoints = 10}
  \endminipage\hfill
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_1e-05_keypoints_28.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-5 and keypoints = 28}
  \endminipage\hfill
  % \minipage{0.2\textwidth}%
  %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_5e-06_keypoints_37.png}
  %   \caption{k = 0.06, sigma = 0.5, t = 5e-6 and keypoints = 37}
  % \endminipage\space\space\space 
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_1e-06_keypoints_86.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-6 and keypoints = 86}
  \endminipage
\end{figure}

\begin{figure}[!h]
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_0.0001_keypoints_23.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-4 and keypoints = 23}
  \endminipage\hfill
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_5e-05_keypoints_51.png}
    \caption{k = 0.04, sigma = 0.5, t = 5e-5 and keypoints = 51}
  \endminipage\hfill
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_1e-05_keypoints_134.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-5 and keypoints = 134}
  \endminipage\hfill
  % \minipage{0.2\textwidth}%
  %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_0.5_t_5e-06_keypoints_173.png}
  %   \caption{k = 0.04, sigma = 0.5, t = 5e-6 and keypoints = 173}
  % \endminipage\space\space\space 
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.04_sigma_1.0_t_1e-06_keypoints_222.png}
    \caption{k = 0.04, sigma = 0.5, t = 1e-6 and keypoints = 222}
  \endminipage
\end{figure}

\begin{figure}[!h]
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_0.0001_keypoints_19.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-4 and keypoints = 19}
    \endminipage\hfill
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-05_keypoints_42.png}
      \caption{k = 0.06, sigma = 0.5, t = 5e-5 and keypoints = 42}
    \endminipage\hfill
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_1e-05_keypoints_115.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-5 and keypoints = 115}
    \endminipage\hfill
    % \minipage{0.2\textwidth}%
    %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-06_keypoints_154.png}
    %   \caption{k = 0.06, sigma = 0.5, t = 5e-6 and keypoints = 154}
    % \endminipage\space\space\space 
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_1.0_t_1e-06_keypoints_191.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-6 and keypoints = 191}
    \endminipage
\end{figure}
\newpage
Furthermore also increasing the sigma should reduce the number of points, as shown in the house image,
since the image has been smoothed. It can happen though that the nois level is already high in the image and therefore increasing the
blurring can help to find more corners, as shown in the blocks image below (sigma = 0.5 and sigma = 2.0). 
\begin{figure}[!h]
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_0.0001_keypoints_4.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-4 and keypoints = 4}
  \endminipage\hfill
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_5e-05_keypoints_10.png}
    \caption{k = 0.06, sigma = 0.5, t = 5e-5 and keypoints = 10}
  \endminipage\hfill
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_1e-05_keypoints_28.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-5 and keypoints = 28}
  \endminipage\hfill
  % \minipage{0.2\textwidth}%
  %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_5e-06_keypoints_37.png}
  %   \caption{k = 0.06, sigma = 0.5, t = 5e-6 and keypoints = 37}
  % \endminipage\space\space\space 
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_0.5_t_1e-06_keypoints_86.png}
    \caption{k = 0.06, sigma = 0.5, t = 1e-6 and keypoints = 86}
  \endminipage
\end{figure}
\begin{figure}[!h]
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_0.0001_keypoints_8.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-4 and keypoints = 8}
  \endminipage\hfill
  \minipage{0.2\textwidth}
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_5e-05_keypoints_18.png}
    \caption{k = 0.06, sigma = 2.0, t = 5e-5 and keypoints = 18}
  \endminipage\hfill
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_1e-05_keypoints_41.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-5 and keypoints = 41}
  \endminipage\hfill
  % \minipage{0.2\textwidth}%
  %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_5e-06_keypoints_50.png}
  %   \caption{k = 0.06, sigma = 2.0, t = 5e-6 and keypoints = 50}
  % \endminipage\space\space\space 
  \minipage{0.2\textwidth}%
    \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/blocks_harris_k_0.06_sigma_2.0_t_1e-06_keypoints_79.png}
    \caption{k = 0.06, sigma = 2.0, t = 1e-6 and keypoints = 79}
  \endminipage
\end{figure}
\begin{figure}[!h]
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_0.0001_keypoints_19.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-4 and keypoints = 19}
    \endminipage\hfill
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-05_keypoints_42.png}
      \caption{k = 0.06, sigma = 0.5, t = 5e-5 and keypoints = 42}
    \endminipage\hfill
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_1e-05_keypoints_115.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-5 and keypoints = 115}
    \endminipage\hfill
    % \minipage{0.2\textwidth}
    %  \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_5e-06_keypoints_154.png}
    %   \caption{k = 0.06, sigma = 0.5, t = 5e-6 and keypoints = 154}
    % \endminipage\space\space\space 
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_0.5_t_1e-06_keypoints_262.png}
      \caption{k = 0.06, sigma = 0.5, t = 1e-6 and keypoints = 262}
    \endminipage
  \end{figure}
\begin{figure}[!htb]
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_2.0_t_0.0001_keypoints_26.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-4 and keypoints = 26}
    \endminipage\hfill
    \minipage{0.2\textwidth}
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_2.0_t_5e-05_keypoints_53.png}
      \caption{k = 0.06, sigma = 2.0, t = 5e-5 and keypoints = 53}
    \endminipage\hfill
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_2.0_t_1e-05_keypoints_103.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-5 and keypoints = 103}
    \endminipage\hfill
    % \minipage{0.2\textwidth}%
    %   \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_2.0_t_5e-06_keypoints_115.png}
    %   \caption{k = 0.06, sigma = 2.0, t = 5e-6 and keypoints = 115}
    % \endminipage\space\space\space 
    \minipage{0.2\textwidth}%
      \includegraphics[width=\linewidth]{../lab02-local-features/results/harris_corner_detection/house_harris_k_0.06_sigma_2.0_t_1e-06_keypoints_144.png}
      \caption{k = 0.06, sigma = 2.0, t = 1e-6 and keypoints = 144}
    \endminipage
  \end{figure}


\newpage
\section{Match descriptors}
The evaluation was done with these parameters
\begin{lstlisting}[language=Python, caption=parameters used to match descriptors]
  HARRIS_SIGMA = 1.0
  HARRIS_K = 0.05
  HARRIS_THRESH = 1e-5
\end{lstlisting}
$\text{Shapley(i)} =  \sum\limits_{S \subseteq N  \setminus \{i\}}\left(|S|! \frac{(n-|S|-1)!}{n!}\right) \Big(\text{HR}(S \cup \{i\}) - \text{HR}(S)\Big)$\\

\subsection{Filter keypoints}
The function to extract descriptors was already given, we needed to filter the keypoints 
found with the method above. Filtering in this case means to remove the points on the border of the image.
The code is the following
\begin{lstlisting}[language=Python, caption=filter keypoints]
  def filter_keypoints(img, keypoints, patch_size = 9):
    '''
    Inputs:
    - keypoints:    (q, 2) numpy array of keypoint locations [x, y]
    Returns:
    - keypoints:    (q', 2) numpy array of keypoint locations [x, y] 
                    that are far enough from edges
    '''
    keypoints = keypoints[(keypoints[:, 0] > patch_size // 2) 
                          & (keypoints[:, 0] < img.shape[1] - patch_size // 2) 
                          & (keypoints[:, 1] > patch_size // 2) 
                          & (keypoints[:, 1] < img.shape[0] - patch_size // 2)]
    
    return keypoints
\end{lstlisting}
\subsection{SSD}
Next, to match descriptors, we need to compute the distances between them.
The smaller the distance, the more correlated the keypoints in two images are.
This can be done with cdist function in scipy.spatial.distance. 
\begin{lstlisting}[language=Python, caption=SSD]
def ssd(desc1, desc2):
    '''
    Sum of squared differences
    Inputs:
    - desc1:        - (q1, feature_dim) descriptor for the first image
    - desc2:        - (q2, feature_dim) descriptor for the first image
    Returns:
    - distances:    - (q1, q2) numpy array storing the squared distance
    '''
    assert desc1.shape[1] == desc2.shape[1]
    return cdist(desc1, desc2, 'sqeuclidean')
  \end{lstlisting}

  The output of the function is for every descriptor in the first image,
  the distance with every descriptor in the second image
  \begin{center}
    $dist[i,j] = \sum\limits_{k = 1}^{\text{feature\_dim}} (desc1[i, k] - desc2[j, k])^2$
  \end{center}

\subsection{One way matching}
One way matching aims to find for each descriptor in the first image, the correspondent 
descriptor with lower distance in the second image.

\begin{lstlisting}[language=Python, caption=One way matching]
  if method == "one_way": # Query the nearest neighbor for each keypoint in image 1
        matches = np.argmin(distances, axis=1)
        matches = np.array([(i, match) for i, match in enumerate(matches)])
\end{lstlisting}

The following image shows the result of one way matching

\begin{figure}[h]
  \centering
  \includegraphics[width=1\textwidth]{../lab02-local-features/results/matching/match_ow.png}
  \caption{One way matching, 298 keypoints}
\end{figure}

As the figure shows, the one way is not very accurate since it 
catch some matching that are not correct (this is shown by the crossing connections).

\subsection{Mutual matching}

Mutual matching is then introduced to relieve the error since 
we will only consider the subset of one way matching couples from the first
image to the second that intersect with the couple found performing one
way matching from the second image to the second.

Therefore we first find the couples of keypoints found by performing 
one way image\textsubscript{1}$\rightarrow$image\textsubscript{2}, take
the couples derived from  image\textsubscript{2}$\rightarrow$image\textsubscript{1}
and we intersect the two sets.

\begin{lstlisting}[language=Python, caption=Mutual matching]

matches_1 = np.argmin(distances, axis=1)
matches_1 = np.array([(i, match) for i, match in enumerate(matches_1)])

matches_2 = np.argmin(distances, axis=0)
matches_2 = np.array([(i, match) for i, match in enumerate(matches_2)])

matches_2 = matches_2[:, [1, 0]]

matches_1_set = set([tuple((match[0], match[1])) for match in matches_1])
matches_2_set = set([tuple((match[0], match[1])) for match in matches_2])

matches = list(matches_1_set.intersection(matches_2_set))
matches = np.array([[match[0], match[1]] for match in matches])
\end{lstlisting}

The following image shows the result of mutual matching

\begin{figure}[!h]
  \centering
  \includegraphics[width=1\textwidth]{../lab02-local-features/results/matching/match_mutual.png}
  \caption{Mutual matching, 210 keypoints}
\end{figure}

It is clear from the image that the error is reduced with respect to one way.
Mutual matching assures that we take only the descriptors that are connected 
in both directions, so we reduce the possible inaccuraties and indeed we see less
cross connections.

\subsection{Ratio test matching}
The ratio test checks if the two closest matches for each feature vector 
are close enough, and if they are, it's considered a valid match.
Below with partition\_first we find the smalles value with respect to the 
distances and with partition\_second the second smallest value, along axis = 1.
\begin{lstlisting}[language=Python, caption=Ratio test matching]

  matches = np.argmin(distances, axis=1)
  matches = np.array([(i, match) for i, match in enumerate(matches)])

  partition_first= np.partition(distances,1,axis=1)[:, 0]

  partition_second = np.partition(distances,1,axis=1)[:, 1]

  matches = matches[partition_first/partition_second < ratio_thresh ]
  \end{lstlisting}
\begin{figure}[!h]
  \centering
  \includegraphics[width=1\textwidth,height=0.22\textheight]{../lab02-local-features/results/matching/match_ratio.png}
  \caption{Ratio test matching, ratio\_thresh = 0.5 and 156 keypoints}
\end{figure}

Clearly the ratio test helps on reducing the error. Playing a little bit with the parameter ratio\_thresh,
we can see the effect on the number of matchings. Increasing the value of 
ratio\_thresh we find more points, since we have a less strict bound, while decreasing the value
of the variable reduces the number of matches.
\begin{figure}[!h]
  \centering
  \includegraphics[width=1\textwidth, height=0.22\textheight]{../lab02-local-features/results/matching/match_ratio_0.7_206_keypoints.png}
  \caption{Ratio test matching, ratio\_thresh = 0.7 and 206 keypoints}
\end{figure}

\begin{figure}[!t]
  \centering
  \includegraphics[width=1\textwidth, height=0.22\textheight]{../lab02-local-features/results/matching/match_ratio_0.2_62_keypoints.png}
  \caption{Ratio test matching, ratio\_thresh = 0.2 and 62 keypoints}
\end{figure}


\end{document}
